#!/usr/bin/env sh

#   generate GRUB ELF files (coreboot payload) and configuration files
#
#	Copyright (C) 2014,2015,2020,2021,2023 Leah Rowe <info@minifree.org>
#
#	This program is free software: you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation, either version 3 of the License, or
#	(at your option) any later version.
#
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with this program.  If not, see <http://www.gnu.org/licenses/>.
#

[ "x${DEBUG+set}" = 'xset' ] && set -v
set -u -e

. "include/err.sh"

grubcfgsdir="resources/grub"
keymap=""

. "${grubcfgsdir}/modules.list"

main()
{
	printf "Creating GRUB payloads and configuration files\n"

	handle_dependencies

	# Separate GRUB payload per keymap to save space in ROM.
	for keylayoutfile in ${grubcfgsdir}/keymap/*.gkb; do
		[ -f "${keylayoutfile}" ] || continue
		build_grub_payloads "${keylayoutfile}"
	done

	printf "Done! Check elf/grub/ to see the files.\n\n"
}

handle_dependencies()
{
	[ -d "grub/" ] || \
		./fetch grub || err "cannot fetch grub"
	[ -f "grub/grub-mkstandalone" ] || \
		./build grub utils || err "cannot build grub utils"
	[ -d "elf/grub" ] || \
		mkdir -p elf/grub || err "cannot create directory, elf/grub"

	rm -f elf/grub/* || err "cannot delete files in directory, elf/grub/"
}

build_grub_payloads()
{
	keylayoutfile=${1}
	[ -f "${keylayoutfile}" ] || continue

	keymap="${keylayoutfile##${grubcfgsdir}/keymap/}"
	keymap="${keymap%.gkb}"

	build_grub_elf "${keylayoutfile}"
	create_grub_config

	printf "Created 'elf/grub/grub_%s.elf' and configs.'\n" "${keymap}"
}

build_grub_elf()
{
	keylayoutfile=${1}

	gcfg="/boot/grub/grub.cfg=${grubcfgsdir}"
	gcfg="${gcfg}/config/grub_memdisk.cfg"
	grubk="/boot/grub/layouts/${keymap}.gkb=${keylayoutfile}"
	grub/grub-mkstandalone \
	    --grub-mkimage="grub/grub-mkimage" \
	    -O i386-coreboot \
	    -o elf/grub/grub_${keymap}.elf \
	    -d grub/grub-core/ \
	    --fonts= --themes= --locales=  \
	    --modules="${grub_modules}" \
	    --install-modules="${grub_install_modules}" \
	    ${gcfg} ${grubk} || \
	    err "cannot create grub payload (grub-mkstandalone)"
}

create_grub_config()
{
	sed "s/usqwerty/${keymap}/" < ${grubcfgsdir}/config/grub.cfg \
	    > elf/grub/grub_${keymap}.cfg || err "sed failed: grub.cfg"
	sed "s/grubtest.cfg/grub.cfg/" < elf/grub/grub_${keymap}.cfg \
	    > elf/grub/grub_${keymap}_test.cfg || err "sed failed: grubtest.cfg"
}

main $@
