#!/usr/bin/env sh
# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-FileCopyrightText: 2014,2015,2016,2020,2021,2023 Leah Rowe <leah@libreboot.org>
# SPDX-FileCopyrightText: 2015 Klemens Nanni <contact@autoboot.org>
# SPDX-FileCopyrightText: 2022 Caleb La Grange <thonkpeasant@protonmail.com>
# SPDX-FileCopyrightText: 2022 Ferass El Hafidi <vitali64pmemail@protonmail.com>

[ "x${DEBUG+set}" = 'xset' ] && set -v
set -u -e

. "include/err.sh"
. "include/option.sh"

read projectname < projectname
opts=""
boards=
first=""
targets=""

main()
{
	[ $# -lt 1 ] && usage && err "target not specified"

	first="${1}"
	[ "${first}" = "help" ] && usage && exit 0
	[ "${first}" = "list" ] && \
	    listitems config/coreboot && exit 0

	while [ $# -gt 0 ]; do
		case ${1} in
		-d)
			opts="${opts} -d ${2}"
			shift ;;
		-p)
			opts="${opts} -p ${2}"
			shift ;;
		-k)
			opts="${opts} -k ${2}"
			shift ;;
		all)
			first="all" ;;
		*)
			boards="${boards} ${1} " ;;
		esac
		shift
	done

	handle_targets
	confirm_targets
}

handle_targets()
{
	[ -z ${opts+x} ] && opts=""
	printf "Building %s ROM images\n" "${projectname}"

	[ "${first}" != "all" ] || boards="$(listitems config/coreboot)" || \
	    err "handle_targets: Cannot get list of boards"

	check_targets
	build_bootroms
}

check_targets()
{
	for board in ${boards}; do
		[ -d "config/coreboot/${board}/" ] || \
			err "check_targets: target not defined: ${board}"
	done
}

build_bootroms()
{
	for board in ${boards}; do
		./build boot roms_helper ${board}${opts} || \
		    err "handle_targets ${board}${opts}: build error"
		[ -d "bin/${board}" ] && targets="${board} ${targets}"
	done
}

confirm_targets()
{
	[ -z "${targets}" ] && err "No ROM images were compiled."
	printf "\n\nYour ROM images are available in these directories:\n"
	for x in ${targets}; do
		printf "* bin/%s\n" "${x}"
	done
}

usage()
{
	cat <<- EOF
	USAGE:	./build boot roms target
	To build *all* boards, do this: ./build boot roms all
	To list *all* boards, do this: ./build boot roms list
	
	Optional Flags:
	-d: displaymode
	-p: payload
	-k: keyboard layout

	Example commands:
		./build boot roms x60
		./build boot roms x200_8mb x60
		./build boot roms x60 -p grub -d corebootfb -k usqwerty

	possible values for 'target':
	$(listitems "config/coreboot")

	Refer to the ${projectname} documentation for more information.
	EOF
}

main $@
